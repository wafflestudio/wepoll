<% content_for :scripts do -%>
  <script type="text/javascript">
    FB.getLoginStatus(function(response) {
      if (response.status === 'connected') {
        // the user is logged in and connected to your
        // app, and response.authResponse supplies
        // the user's ID, a valid access token, a signed
        // request, and the time the access token 
        // and signed request each expire
        var uid = response.authResponse.userID;
        var accessToken = response.authResponse.accessToken;
//        alert("connected");
      } else if (response.status === 'not_authorized') {
        // the user is logged in to Facebook, 
        //but not connected to the app
//        alert("not authorized");
      } else {
        // the user isn't even logged in to Facebook.
//        alert("not logged in");
      }
    });

  </script>
  <script type="text/javascript">
    var district_positions = [{name:"도봉을",x:453,y:84},{name:"노원병",x:520,y:90},{name:"강북갑",x:407,y:145},{name:"도봉갑",x:470,y:142},{name:"노원을",x:523,y:140},{name:"강북을",x:450,y:200},{name:"노원갑",x:528,y:189},{name:"은평을",x:310,y:172},{name:"종로",x:365,y:254},{name:"성북갑",x:412,y:230},{name:"성북을",x:475,y:231},{name:"중랑을",x:554,y:228},{name:"동대문갑",x:485,y:266},{name:"동대문을",x:506,y:295},{name:"중랑갑",x:550,y:274},{name:"은평갑",x:281,y:249},{name:"서대문을",x:324,y:255},{name:"서대문갑",x:321,y:300},{name:"마포갑",x:313,y:347},{name:"마포을",x:244,y:314},{name:"중구",x:400,y:320},{name:"용산",x:380,y:375},{name:"광진을",x:531,y:363},{name:"광진갑",x:553,y:329},{name:"강서을",x:110,y:295},{name:"강서갑",x:169,y:358},{name:"양천갑",x:209,y:383},{name:"양천을",x:156,y:401},{name:"구로갑",x:153,y:455},{name:"구로을",x:224,y:446},{name:"금천",x:256,y:513},{name:"관악을",x:307,y:508},{name:"관악갑",x:345,y:490},{name:"동작을",x:361,y:442},{name:"동작갑",x:307,y:427},{name:"영등포을",x:278,y:413},{name:"영등포갑",x:254,y:389},{name:"서초갑",x:410,y:430},{name:"서초을",x:439,y:485},{name:"강남갑",x:474,y:408},{name:"강남을",x:537,y:466},{name:"송파을",x:542,y:420},{name:"송파병",x:620,y:449},{name:"송파갑",x:579,y:402},{name:"강동을",x:618,y:362},{name:"강동갑",x:659,y:319}];
    var isCanvas;
    function isCanvasSupported(){
      var elem = document.createElement('canvas');
      return !!(elem.getContext && elem.getContext('2d'));
    }

    function clearCurve() {
      if (isCanvas) {
        context.clearRect(0, 0, canvas.width, canvas.height);
      }

      $("#arrow-header").hide();
    }

    function drawCurve(indx) {
      //context.clearRect(0, 0, canvas.width, canvas.height);
      clearCurve();
      console.log("draw-curve");
      var district = district_positions[indx];
      console.log(indx + ", "+ district.name);
      var bezier = new $.path.bezier({
        start:{
          x:district.x,y:district.y, angle:50, length:0.4
        },
        end:{
          x:700,y:120, angle:50, length:0.4
        }
      });

      var tx1,tx2,ty1,ty2;
      for (var t=0; ;t+=0.1) {

        if (t>0.9) break;

        var o = bezier.css(t);
        var x1 = parseFloat(o.left);
        var y1 = parseFloat(o.top);

        o = bezier.css(t+0.03);
        var x2 = parseFloat(o.left);
        var y2 = parseFloat(o.top);

        if (t > 0.8) {
          tx1 = x1; ty1 = y1;
          tx2 = x2; ty2 = y2;
          console.log("("+tx1+","+ty1+")->("+tx2+","+ty2+")");
        }

        context.beginPath();
        context.strokeStyle="#4f4f50";
        context.moveTo(x1, y1);
        context.lineTo(x2, y2);
        context.lineWidth=5;
        context.lineCap = 'round';
        context.stroke();
      }

      $("#arrow-header").show();

      var rotate_angle = Math.atan2(ty1-ty2, tx1-tx2);
      console.log("rot: "+rotate_angle);

//      $("#arrow-header").css("left", "660px");
//      $("#arrow-header").css("top", "96px");

      $("#arrow-header").css("-webkit-transform", "rotate("+rotate_angle+"rad)");
      $("#arrow-header").css("-o-transform", "rotate("+rotate_angle+"rad)");
      $("#arrow-header").css("-moz-transform", "rotate("+rotate_angle+"rad)");
      $("#arrow-header").css("-ms-transform", "rotate("+rotate_angle+"rad)");

//      $("#arrow-header").css("-webkit-transform", "translate("+rotate_angle+"rad)");
//      $("#arrow-header").css("-o-transform", "translate("+rotate_angle+"rad)");
//      $("#arrow-header").css("-moz-transform", "translate("+rotate_angle+"rad)");
//      $("#arrow-header").css("-ms-transform", "translate("+rotate_angle+"rad)");
    }

    var canvas;
    var context;

    canvas = document.getElementById("line-canvas");
    context = canvas.getContext("2d");

    $(document).ready(function() {
      isCanvas = isCanvasSupported();
      $("#vs-container").css("visibility","hidden");

      /* for dev */
      /************************/
      for (i in district_positions) {
        var district = district_positions[i];
        var $div = $("<div/>");
        $div.css("left",district.x-10+"px")
        .css("top", district.y-10+"px")
        .css("width", "20px")
        .css("height", "20px")
        .css("background-color", "#eee")
        .css("position","absolute")
        .attr("data-x", district.x)
        .attr("data-y", district.y)
        .attr("data-index", i)
        .attr("data-name", district.name)
        .addClass("district-center");
        $("#seoul-map").append($div);
      }
      /************************/

      //TODO : according to cookie value, select map which not shown
      $("#busan-map").removeClass("selected");
      $("#seoul-map").addClass("selected");

      $(".district-center").hover(function() {
        var $this = $(this);
        var x = parseInt($this.attr("data-x"));
        var y = parseInt($this.attr("data-y"));
        $("#vs-container").css("visibility","visible");
        drawCurve(parseInt($this.attr("data-index")));
      }, function() {
        $("#vs-container").css("visibility","hidden");
        clearCurve();
      });

      $("#region-selector .region").click(function() {
        $("#region-selector .region").removeClass("selected");
        $(this).addClass("selected");

        var region = $(this).attr("id").split("-")[0];
        $(".small-map").removeClass("selected");
        $("#"+region+"-small-map").addClass("selected");

        $(".map").removeClass("selected");
        $("#"+region+"-map").addClass("selected");
      });
    });
  </script>
<% end -%>


<div id="seoul-map" class="map">
  <div id="seoul-map-bubble" class="bubble">
    <div class="bubble-text">
      서울시 지도에<br />
      마우스를 올려보세요!
    </div>
  </div>

  <%= image_tag '/assets/dummy_map.gif' %>
  <!--  <div id="dest" style="position:absolute;left:690px;top:100px;width:10px;height:10px;background-color:red;"></div>-->
  <canvas id="line-canvas" width="752" height="639"></canvas>

  <div id="arrow-header">
    <%= image_tag "/assets/arrow_hd.gif" %>
  </div>
</div>

<div id="busan-map" class="map">
  <div id="busan-map-bubble" class="bubble">
    <div class="bubble-text">
      부산시 지도에<br />
      마우스를 올려보세요!
    </div>
  </div>

  <%= image_tag '/assets/dummy_busan_map.png' %>
</div>

<% content_for :sidebar do -%>
  <div id="region-selector">
    <div class="clearfix">
      <%= link_to "서울", '#', :id => "seoul-region", :class => "region selected" %>
      <%= link_to "부산", '#', :id => "busan-region", :class => "region" %>
    </div>
    <div class="small-map-container">
      <a class="small-map selected" id="seoul-small-map" href="#">
        <%= image_tag '/assets/seoul_map_small.gif' %>
      </a>

      <a class="small-map" id="busan-small-map" href="#">
        <%= image_tag '/assets/busan_map_small.gif' %>
      </a>
    </div>
  </div>

  <h3 class="link-section-header">최신링크 <small><%= link_to '더보기', '#'%></small></h3>
  <div class="links-container grid_4 alpha omega" id="recent-links">
    <% @recent_timeline_entries.each do |link| -%>
      <%= render :partial => 'link', :locals => {:link => link } %>
    <% end -%>

    <% if @recent_timeline_entries.empty? -%>
      <%= render :partial => 'link', :locals => {:link => nil} %>
    <% end -%>
  </div>

  <h3 class="link-section-header">인기링크 <small><%= link_to '더보기', '#'%></small></h3>
  <div class="links-container grid_4 alpha omega" id="popular-links">
    <% @popular_timeline_entries.each do |link| -%>
      <%= render :partial => 'link', :locals => {:link => link} %>
    <% end -%>

    <% if @recent_timeline_entries.empty? -%>
      <%= render :partial => 'link', :locals => {:link => nil }%>
    <% end -%>
  </div>

  <!-- vs-container is absolute positioned -->
  <div id="vs-container" class="clearfix">
    <h3 id="vs-district">지역구</h3>
    <div class="vs-part alpha"></div>
    <div class="vs-part omega"></div>
  </div>
<% end -%>
